
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isLibraryUser(libraryId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid));
    }

    function isAdmin(libraryId) {
      return isLibraryUser(libraryId) &&
        get(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid)).data.role == "libraryOwner";
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- COLLECTIONS ---

    // Libraries: Read-only for clients
    match /libraries/{libraryId} {
      allow get: if isLibraryUser(libraryId);
      allow list, create, update, delete: if false;
    }

    // Users: Can read/write their own user object
    match /libraries/{libraryId}/users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Students: Admins manage, all library users can read
    match /libraries/{libraryId}/students/{studentId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }

    // Payments: Admins manage, all library users can read
    match /libraries/{libraryId}/payments/{paymentId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }

    // Expenses: Admins manage, all library users can read
    match /libraries/{libraryId}/expenses/{expenseId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }

    // Rooms & Seats: Admins manage, all library users can read
    match /libraries/{libraryId}/rooms/{roomId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);

      match /seats/{seatId} {
        allow read: if isLibraryUser(libraryId);
        allow create, update, delete: if isAdmin(libraryId);
      }
    }

    // Announcements: Admins manage, all library users can read
    match /libraries/{libraryId}/announcements/{announcementId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }

    // Suggestions: Students create their own, Admins manage all
    match /libraries/{libraryId}/suggestions/{suggestionId} {
      allow read: if isLibraryUser(libraryId);
      allow create: if isLibraryUser(libraryId) && request.auth.uid == request.resource.data.studentId;
      allow update, delete: if isAdmin(libraryId);
    }

    // Print Requests: Students create their own, Admins manage all
    match /libraries/{libraryId}/printRequests/{printRequestId} {
      allow read: if isLibraryUser(libraryId);
      allow create: if isLibraryUser(libraryId) && request.auth.uid == request.resource.data.studentId;
      allow update, delete: if isAdmin(libraryId);
    }
    
    // Activity Logs: Write-only for admins, read-only for admins
    match /libraries/{libraryId}/activityLogs/{logId} {
      allow read, create: if isAdmin(libraryId);
      allow update, delete: if false;
    }
  }
}
