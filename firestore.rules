
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isLibraryUser(libraryId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid));
    }

    function isAdmin(libraryId) {
      return isLibraryUser(libraryId) &&
        get(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid)).data.role == "libraryOwner";
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- COLLECTIONS ---

    // Libraries: Read-only for clients, no one can list.
    match /libraries/{libraryId} {
      allow get: if isLibraryUser(libraryId);
      allow list, create, update, delete: if false;
    }

    // Users: Can read/write their own user object. No one can list.
    match /libraries/{libraryId}/users/{userId} {
      allow get, write: if isOwner(userId);
      allow list: if false;
    }

    // Students: Admins manage fully. Students can read their own profile. Authenticated library users can list.
    match /libraries/{libraryId}/students/{studentId} {
      allow get: if isOwner(studentId) || isAdmin(libraryId);
      allow list: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }
    
    // Seat Bookings: Library users can read/list. Admins can create/delete.
    match /libraries/{libraryId}/seatBookings/{bookingId} {
        allow read, list: if isLibraryUser(libraryId);
        allow create, delete: if isAdmin(libraryId);
        // updates are not allowed, must cancel and re-book
        allow update: if false;
    }

    // Payments: Admins manage. Any authenticated user in the library can read/list.
    match /libraries/{libraryId}/payments/{paymentId} {
      allow read: if isLibraryUser(libraryId);
      allow create, update, delete: if isAdmin(libraryId);
    }
    match /libraries/{libraryId}/payments/{paymentId} {
      allow list: if isLibraryUser(libraryId);
    }

    // Expenses: Only Admins can C/R/U/D.
    match /libraries/{libraryId}/expenses/{expenseId} {
      allow read, write: if isAdmin(libraryId);
    }
     match /libraries/{libraryId}/expenses/{expenseId} {
      allow list: if isAdmin(libraryId);
    }

    // Rooms & Seats: Admins manage. Any authenticated user in the library can read/list.
    match /libraries/{libraryId}/rooms/{roomId} {
      allow read, list: if isLibraryUser(libraryId);
      allow write: if isAdmin(libraryId);

      match /seats/{seatId} {
        allow read, list: if isLibraryUser(libraryId);
        allow write: if isAdmin(libraryId);
      }
    }

    // Announcements: Admins manage. Any authenticated user in the library can read/list.
    match /libraries/{libraryId}/announcements/{announcementId} {
      allow read, list: if isLibraryUser(libraryId);
      allow write: if isAdmin(libraryId);
    }

    // Suggestions: Students create their own. Admins can R/U/D all.
    match /libraries/{libraryId}/suggestions/{suggestionId} {
      allow read, list: if isLibraryUser(libraryId);
      allow create: if isOwner(request.resource.data.studentId);
      allow update, delete: if isAdmin(libraryId);
    }

    // Print Requests: Students create their own. Admins can R/U/D all.
    match /libraries/{libraryId}/printRequests/{printRequestId} {
      allow read, list: if isLibraryUser(libraryId);
      allow create: if isOwner(request.resource.data.studentId);
      allow update, delete: if isAdmin(libraryId);
    }
    
    // Activity Logs: Admins can create and read. No updates or deletes.
    match /libraries/{libraryId}/activityLogs/{logId} {
      allow read, create: if isAdmin(libraryId);
      allow update, delete: if false;
    }
  }
}
