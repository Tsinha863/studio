rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isLibraryUser(libraryId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid));
    }

    function isAdmin(libraryId) {
      return isLibraryUser(libraryId) &&
        get(/databases/$(database)/documents/libraries/$(libraryId)/users/$(request.auth.uid)).data.role == "libraryOwner";
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isLibraryOwner(libraryId) {
        return isAdmin(libraryId) && get(/databases/$(database)/documents/libraries/$(libraryId)).data.ownerId == request.auth.uid;
    }

    // --- TOP-LEVEL COLLECTIONS ---

    // User-to-Library mapping: users can read their own mapping to find their library.
    // Creation/update should only happen via secure backend logic (e.g., signup transaction).
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list, write: if false;
    }

    // --- LIBRARY-SCOPED COLLECTIONS ---

    // Libraries: Admins can update settings. Any user in the library can read.
    match /libraries/{libraryId} {
      allow read: if isLibraryUser(libraryId);
      allow update: if isAdmin(libraryId);
      allow create, delete: if false;
    }

    // Users: Can read/write their own user object. Admins can list all users in their library.
    match /libraries/{libraryId}/users/{userId} {
      allow get: if isOwner(userId) || isAdmin(libraryId);
      allow list: if isAdmin(libraryId);
      allow write: if isOwner(userId);
    }

    // Students: Admins manage fully. Students can read their own profile.
    match /libraries/{libraryId}/students/{studentId} {
      allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || isOwner(studentId));
      allow list: if isAdmin(libraryId);
      allow write: if isAdmin(libraryId);
    }
    
    // Seat Bookings: Library users can read. Admins can write.
    match /libraries/{libraryId}/seatBookings/{bookingId} {
        allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || resource.data.studentId == request.auth.uid);
        allow list: if isAdmin(libraryId);
        allow write: if isAdmin(libraryId);
    }
    
    // Bills: Admins manage. Students can read their own.
    match /libraries/{libraryId}/bills/{billId} {
      allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || resource.data.studentId == request.auth.uid);
      allow list: if isAdmin(libraryId);
      allow write: if isAdmin(libraryId);
    }

    // Payments: Admins can create. Students can read their own. Payments are immutable.
    match /libraries/{libraryId}/payments/{paymentId} {
      allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || resource.data.studentId == request.auth.uid);
      allow list: if isAdmin(libraryId);
      allow create: if isAdmin(libraryId);
      allow update, delete: if false; // Payments are immutable
    }

    // Expenses: Only Admins can C/R/U/D.
    match /libraries/{libraryId}/expenses/{expenseId} {
      allow read, write: if isAdmin(libraryId);
    }

    // Rooms & Seats: Admins manage. Library users can read.
    match /libraries/{libraryId}/rooms/{roomId} {
      allow read: if isLibraryUser(libraryId);
      allow write: if isAdmin(libraryId);

      match /seats/{seatId} {
        allow read: if isLibraryUser(libraryId);
        allow write: if isAdmin(libraryId);
      }
    }

    // Announcements: Admins manage. Library users can read.
    match /libraries/{libraryId}/announcements/{announcementId} {
      allow read: if isLibraryUser(libraryId);
      allow write: if isAdmin(libraryId);
    }

    // Suggestions: Students create their own. Admins can manage all.
    match /libraries/{libraryId}/suggestions/{suggestionId} {
      allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || resource.data.studentId == request.auth.uid);
      allow list: if isAdmin(libraryId);
      allow create: if isOwner(request.resource.data.studentId);
      allow update, delete: if isAdmin(libraryId);
    }

    // Print Requests: Students create their own. Admins can manage all.
    match /libraries/{libraryId}/printRequests/{printRequestId} {
      allow get: if isLibraryUser(libraryId) && (isAdmin(libraryId) || resource.data.studentId == request.auth.uid);
      allow list: if isAdmin(libraryId);
      allow create: if isOwner(request.resource.data.studentId);
      allow update, delete: if isAdmin(libraryId);
    }
    
    // Activity Logs: Admins can create and read. No updates or deletes.
    match /libraries/{libraryId}/activityLogs/{logId} {
      allow get: if isAdmin(libraryId);
      allow list, create: if isAdmin(libraryId);
      allow update, delete: if false;
    }
    
    // Invites: Admins can read and write. This is a placeholder; a full student join flow would require more granular rules or a Cloud Function.
    match /libraries/{libraryId}/invites/{inviteId} {
        allow read, write: if isAdmin(libraryId);
    }
    
    // Ownership Transfers: Admins can read. Owner can create/cancel. Recipient can accept.
    match /libraries/{libraryId}/ownershipTransfers/{transferId} {
        allow read: if isAdmin(libraryId);
        // Only the current library owner can initiate a transfer.
        allow create: if isLibraryOwner(libraryId);
        // The owner can cancel (update status to 'cancelled'), or the recipient can accept (update status to 'accepted').
        allow update: if (isLibraryOwner(libraryId) && request.resource.data.status == 'cancelled') || (request.auth.uid == resource.data.toUserId && request.resource.data.status == 'accepted');
        allow delete: if false; // Transfers are a permanent record.
    }
  }
}
